# ccgraph と ccusage の料金計算差異分析レポート

## 実行日時
2025-06-28

## 概要
ccgraph の料金計算で 6月28日のコストが約$12.15 と表示されているが、ccusage では約$11.78 と表示されている。約$0.37 の差異が確認された。また、ユーザーが報告している約$46 という値は、どちらのツールでも確認されていない。

## 詳細比較

### 6月28日のデータ比較

| ツール | Input | Output | Cache Creation | Cache Read | Total Tokens | Cost (USD) |
|--------|-------|---------|----------------|------------|--------------|------------|
| ccusage | 19,620 | 31,043 | 699,353 | ~16,010,000 | 16,760,598 | $11.78 |
| ccgraph | 4,447 | 12,349 | 617,565 | 7,268,971 | 7,903,332 | $12.15 |
| **差異** | **-15,173** | **-18,694** | **-81,788** | **-8,741,029** | **-8,857,266** | **+$0.37** |

### 発見された問題

#### 1. データ量の大幅な差異
- ccgraph で取得しているトークン数が ccusage の約半分
- 特に Cache Read トークンで大きな差異（8.7M トークン不足）
- Input/Output トークンも大幅に不足

#### 2. 重複データの存在
ccgraph のデバッグ出力で、同じタイムスタンプの重複エントリを発見：
```
Time: 2025-06-28T06:53:04.578Z
```
この時刻で複数のエントリが重複していることが確認された。

#### 3. モデル分類の統計
ccgraph での6月28日の分類：
- claude-sonnet-4-20250514: 127回
- claude-opus-4-20250514: 115回
- `<synthetic>`: 4回 (合計246エントリ)

#### 4. 料金計算の正確性
ccgraph の価格設定は Anthropic 公式料金と一致：
- Opus Input: $15/MTok, Output: $75/MTok
- Opus Cache Write: $18.75/MTok, Cache Read: $1.50/MTok
- Sonnet Input: $3/MTok, Output: $15/MTok
- Sonnet Cache Write: $3.75/MTok, Cache Read: $0.30/MTok

## 考えられる原因

### 1. データ収集の不完全性
- 全プロジェクトのJSONLファイルを正しく読み込めていない可能性
- 特定のプロジェクトディレクトリが除外されている可能性
- ファイル読み込みエラーで一部データが失われている可能性

### 2. 重複除去の問題
- 重複データが正しく処理されていない
- タイムスタンプが同じエントリの扱いが不適切

### 3. 日付フィルタリングの問題
- 過去30日間のフィルタリングロジックに問題がある可能性
- タイムゾーンの扱いに問題がある可能性

### 4. ccusage との実装差異
- ccusage とは異なるデータ集計ロジックを使用している
- 異なるJSONLファイルの解釈方法

## 推奨される修正内容

### 緊急対応（High Priority）
1. **データ収集の完全性確保**
   - 全プロジェクトディレクトリの正確な探索
   - ファイル読み込みエラーハンドリングの改善
   - 読み込まれたエントリ数の詳細ログ

2. **重複データの適切な処理**
   - 同一タイムスタンプエントリの重複除去ロジック実装
   - UUID ベースでの重複除去の検討

### 中期対応（Medium Priority）
3. **ccusage との比較検証**
   - ccusage の実装ロジックを参考にした改善
   - 同一データソースでの結果一致の確保

4. **デバッグ機能の強化**
   - より詳細なトークン統計表示
   - プロジェクト別の集計表示
   - エラー発生時の詳細ログ

### 長期対応（Low Priority）
5. **テストケースの追加**
   - 既知のデータでの料金計算テスト
   - ccusage との結果比較テスト

## 結論
ccgraph の料金計算は基本的に正確だが、データ収集の段階で不完全になっている。特に重複データの処理と全データの確実な読み込みが課題。ccusage と同等の精度を達成するためには、データ収集ロジックの見直しが必要。

ユーザーが報告した$46という値については、どちらのツールでも確認されておらず、別の期間や計算方法による可能性が考えられる。